"use strict";exports.id=5947,exports.ids=[5947],exports.modules={5947:(a,b,c)=>{c.r(b),c.d(b,{default:()=>g});var d=c(8732),e=c(2015),f=c(1729);let g=({isShowing:a,onClose:b,onCameraReady:c,showHeadPose:g=!1,showBoundingBox:h=!1,showMask:i=!1,showParameters:j=!1})=>{let k=(0,e.useRef)(null),l=(0,e.useRef)(null),m=(0,e.useRef)(null),n=(0,e.useRef)(null),[o,p]=(0,e.useState)(null),[q,r]=(0,e.useState)(""),[s,t]=(0,e.useState)(0),u=(0,e.useRef)(null),v=(0,e.useRef)(null),[w,x]=(0,e.useState)({width:0,height:0}),[y,z]=(0,e.useState)(!1),[A,B]=(0,e.useState)(null);(0,e.useRef)([]),(0,e.useRef)(!1);let[C,D]=(0,e.useState)("disconnected"),[E,F]=(0,e.useState)(!1),G=()=>{n.current&&(n.current.close(1e3,"User requested disconnect"),n.current=null,D("disconnected"),F(!1),v.current&&(clearInterval(v.current),v.current=null),l.current&&l.current.getContext("2d").clearRect(0,0,l.current.width,l.current.height))};(0,e.useEffect)(()=>a?()=>{G()}:void G(),[a]);let H=()=>{if(!k.current||!l.current||!y||!n.current)return;let a=k.current,b=l.current,c=b.getContext("2d");n.current&&n.current.readyState===WebSocket.OPEN&&(c.clearRect(0,0,b.width,b.height),c.save(),c.translate(b.width,0),c.scale(-1,1),c.drawImage(a,0,0,b.width,b.height),c.restore(),b.toBlob(a=>{a&&n.current&&n.current.readyState===WebSocket.OPEN&&n.current.send(a)},"image/jpeg",.95))},I=async()=>{r(""),z(!1);try{if(("undefined"==typeof navigator||!navigator.mediaDevices)&&("undefined"!=typeof navigator&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia||(navigator.mediaDevices.getUserMedia=function(a){let b=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return b?new Promise(function(c,d){b.call(navigator,a,c,d)}):Promise.reject(Error("getUserMedia is not implemented in this browser"))})),"https:"!==window.location.protocol&&"localhost"!==window.location.hostname&&"127.0.0.1"!==window.location.hostname)throw Error("Camera access requires HTTPS or localhost. Please use HTTPS or run the application on localhost.");console.log("Starting camera access with highest resolution...");let a=await (0,f.getHighestResolutionConstraints)();console.log("Using camera constraints:",a);let b=await navigator.mediaDevices.getUserMedia({...a,audio:!1});if(console.log("High resolution camera access granted!"),p(b),k.current){k.current.playsInline=!0,k.current.muted=!0,k.current.autoplay=!0,k.current.srcObject=b;try{await k.current.play(),console.log("Video playing successfully!"),z(!0),"connected"===C&&(v.current=setInterval(H,33))}catch(a){console.error("Error playing video:",a),r("Unable to start video stream. Please try again.")}}}catch(b){console.error("Camera access error:",b);let a="Camera error: ";"NotAllowedError"===b.name?a+="Camera access was denied. Please allow camera access in your browser settings.":"NotFoundError"===b.name?a+="No camera found. Please connect a camera and try again.":"NotReadableError"===b.name?a+="Camera is already in use by another application.":"OverconstrainedError"===b.name?a+="Camera does not support the requested resolution.":"getUserMedia is not implemented in this browser"===b.message?a+="Your browser does not support camera access. Please try using a modern browser like Chrome, Firefox, or Edge.":a+=b.message||"Unknown error",r(a)}},J=()=>{o&&(o.getTracks().forEach(a=>a.stop()),p(null)),k.current&&(k.current.srcObject=null),v.current&&(clearInterval(v.current),v.current=null),z(!1)};(0,e.useEffect)(()=>(a?I():J(),()=>{J()}),[a]),(0,e.useEffect)(()=>{if(a)return u.current=setInterval(()=>{t(a=>Math.floor(10*Math.random())+25)},1e3),()=>{u.current&&clearInterval(u.current),v.current&&clearInterval(v.current)}},[a]),(0,e.useEffect)(()=>{if(!a)return;let b=()=>{if(m.current){let{width:a,height:b}=m.current.getBoundingClientRect();x({width:a,height:b})}};return b(),window.addEventListener("resize",b),()=>window.removeEventListener("resize",b)},[a]),(0,e.useEffect)(()=>{if(!a||!k.current||!o)return;let b=k.current,d=()=>{console.log("Video metadata loaded"),z(!0);let a=b.videoWidth||640,d=b.videoHeight||480;if(console.log(`Video dimensions: ${a}x${d}`),l.current){l.current.width=a,l.current.height=d;let b=a/d,c=w.width;l.current.style.width=`${c}px`,l.current.style.height=`${c/b}px`}K(),c&&c({width:a,height:d})};return b.addEventListener("loadedmetadata",d),()=>{b.removeEventListener("loadedmetadata",d)}},[o,a,w,c]);let K=()=>{if(!l.current||!k.current||!y)return;let a=k.current,b=l.current,c=b.getContext("2d");v.current=setInterval(()=>{if(4!==a.readyState)return;c.clearRect(0,0,b.width,b.height),c.save(),c.translate(b.width,0),c.scale(-1,1),c.drawImage(a,0,0,b.width,b.height),c.restore();let d=Math.random()>.1;d&&(h&&L(c,b),g&&M(c,b),i&&N(c,b)),j&&O(c,b,d)},33)},L=(a,b)=>{let c=b.width/2,d=b.height/2,e=.6*b.width,f=.8*b.height;a.strokeStyle="rgba(255, 255, 0, 0.7)",a.lineWidth=2,a.strokeRect(c-e/2,d-f/2,e,f)},M=(a,b,c,d,e)=>{let f=b.width/2,g=b.height/2,h=Date.now()/1e3,i=.1*b.width;a.beginPath(),a.moveTo(f,g),a.lineTo(f+i*Math.sin(h),g),a.strokeStyle="red",a.lineWidth=3,a.stroke(),a.beginPath(),a.moveTo(f,g),a.lineTo(f,g+i*Math.sin(h+1)),a.strokeStyle="green",a.lineWidth=3,a.stroke(),a.beginPath(),a.moveTo(f,g),a.lineTo(f+i/2*Math.sin(h+2),g-i/2*Math.cos(h+2)),a.strokeStyle="blue",a.lineWidth=3,a.stroke()},N=(a,b,c)=>{let d=b.width/2,e=b.height/2,f=.2*Math.min(b.width,b.height);a.fillStyle="rgba(0, 255, 255, 0.2)",a.beginPath(),a.arc(d,e,f,0,2*Math.PI),a.fill();let g=.2*f,h=.3*f,i=.1*f;a.fillStyle="rgba(255, 255, 255, 0.7)",a.beginPath(),a.arc(d-h,e-i,g,0,2*Math.PI),a.fill(),a.beginPath(),a.arc(d+h,e-i,g,0,2*Math.PI),a.fill()},O=(a,b,c)=>{a.fillStyle="rgba(0, 0, 0, 0.7)",a.fillRect(5,b.height-60,150,50),a.font="12px Arial",a.fillStyle="white",a.fillText(`Resolution: ${b.width}x${b.height}`,10,b.height-40),a.fillText(`FPS: ${s}`,10,b.height-25),a.fillText(`Face: ${c?"Detected":"Not Detected"}`,10,b.height-10)};return a?(0,d.jsxs)("div",{ref:m,style:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:"30vw",height:"30vh",backgroundColor:"white",borderRadius:"8px",boxShadow:"0 4px 8px rgba(0, 0, 0, 0.2)",overflow:"hidden",zIndex:1e3},children:[(0,d.jsx)("video",{ref:k,style:{width:"100%",height:"100%",objectFit:"cover",transform:"scaleX(-1)",opacity:1},playsInline:!0,muted:!0,autoPlay:!0}),(0,d.jsx)("canvas",{ref:l,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",zIndex:1,pointerEvents:"none",display:E?"block":"none"}}),(0,d.jsxs)("div",{style:{position:"absolute",top:"10px",right:"10px",display:"flex",gap:"10px",zIndex:2},children:[(0,d.jsx)("button",{onClick:b,style:{padding:"8px 12px",backgroundColor:"rgba(0, 0, 0, 0.5)",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",transition:"background-color 0.3s ease"},children:"Close"}),(0,d.jsx)("button",{onClick:()=>{E?G():(()=>{if(n.current&&n.current.readyState===WebSocket.OPEN)return console.log("WebSocket already connected");D("connecting");try{let a=process.env.NEXT_PUBLIC_WS_URL||"ws://localhost:8010",b=new WebSocket(`${a}/ws/video`);n.current=b;let c=setTimeout(()=>{b.readyState!==WebSocket.OPEN&&(console.error("WebSocket connection timeout"),b.close(),D("error"),r("Connection timeout. Please check if the backend server is running."),F(!1))},5e3);b.onopen=()=>{console.log("WebSocket connected to FastAPI backend"),clearTimeout(c),D("connected"),r(""),F(!0),y&&(v.current=setInterval(H,33))},b.onmessage=a=>{try{let b=JSON.parse(a.data);B(b),(a=>{if(!l.current||!a)return;let b=l.current,c=b.getContext("2d");if(a.bounding_box&&h){let{x:b,y:d,width:e,height:f}=a.bounding_box;c.strokeStyle="rgba(255, 0, 0, 0.8)",c.lineWidth=2,c.strokeRect(b,d,e,f)}if(a.head_pose&&g){let{pitch:d,yaw:e,roll:f}=a.head_pose;M(c,b,d,e,f)}if(a.face_mask&&i){let{points:d}=a.face_mask;N(c,b,d)}j&&O(c,b,a)})(b)}catch(a){console.error("Error parsing WebSocket message:",a)}},b.onerror=a=>{console.error("WebSocket error:",a),clearTimeout(c),D("error"),r("Failed to connect to FastAPI backend. Please check if the server is running."),F(!1)},b.onclose=a=>{console.log("WebSocket disconnected:",a.code,a.reason),clearTimeout(c),D("disconnected"),F(!1),v.current&&(clearInterval(v.current),v.current=null),1e3!==a.code&&r(`WebSocket connection closed: ${a.reason||"Unknown reason"}`)}}catch(a){console.error("Error creating WebSocket:",a),D("error"),r("Failed to create WebSocket connection. Please check your network connection."),F(!1)}})()},style:{padding:"8px 12px",backgroundColor:E?"rgba(255, 0, 0, 0.7)":"rgba(0, 255, 0, 0.7)",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",transition:"background-color 0.3s ease"},children:E?"Unlink":"Link"})]}),"error"===C&&(0,d.jsxs)("div",{style:{position:"absolute",top:"50px",right:"10px",padding:"8px 12px",backgroundColor:"rgba(255, 0, 0, 0.7)",color:"white",borderRadius:"4px",zIndex:2},children:["Connection Error: ",q]})]}):null}}};